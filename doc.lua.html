<!doctype html><html><head>
  <meta charset=utf-8>
  <title>Reference</title>
  <link href="style.css" rel="stylesheet" type="text/css"></meta>

</head><body>
  <div id=content>
<h1> helper functions</h1><p> Functions for parsing, running code samples and html generation.
<pre class=run>&nbsp;&nbsp;doc&nbsp;<span class=operator>=</span>&nbsp;require&nbsp;<span class=string>"doc"</span></pre><pre class=success>nil</pre>
 See #doc.parse for how it expects your files to be written.
<div class=turnable>
  <input id=code-folder type=checkbox>
  <label for=code-folder>View source-code</label>
  <div><pre id=folded-code style=width:inherit>
<span class=comment>--- helper functions</span><br><span class=comment>-- Functions for parsing, running code samples and html generation.</span><br><span class=comment>--[[</span><br>&nbsp;&nbsp;doc&nbsp;<span class=operator>=</span>&nbsp;require&nbsp;<span class=string>"doc"</span><br><span class=operator>]</span><span class=operator>]</span><span class=comment>--@RUN</span><br><span class=comment>-- See #doc.parse for how it expects your files to be written.</span><br><br><span class=keyword>local</span>&nbsp;highlight&nbsp;<span class=operator>=</span>&nbsp;require&nbsp;<span class=string>"highlight"</span><br><span class=keyword>local</span>&nbsp;repr&nbsp;<span class=operator>=</span>&nbsp;require&nbsp;<span class=string>"repr"</span><br><br><span class=keyword>local</span>&nbsp;ok,res&nbsp;<span class=operator>=</span>&nbsp;pcall<span class=operator>(</span>require,&nbsp;<span class=string>"traceback"</span><span class=operator>)</span><br><span class=keyword>if</span>&nbsp;ok&nbsp;<span class=keyword>then</span>&nbsp;traceback&nbsp;<span class=operator>=</span>&nbsp;res&nbsp;<span class=keyword>end</span><br><span class=keyword>local</span>&nbsp;doc&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>}</span><br><br><span class=comment>--- Parse documention from file.</span><br><span class=comment>-- returns a list of sections, where each section is a list of defintions plus a description.</span><br><span class=comment>--</span><br><span class=comment>-- A Doccomment begins with <span class=string>'---'</span> and continues with <span class=string>'--'</span>, newlines are ignored,</span><br><span class=comment>-- empty lines seperate paragraphs. For example:</span><br><span class=comment>--[[</span><br><span class=comment>--- Add 2 numbers.</span><br><span class=comment>-- This function the two numbers <span class=string>'x'</span> and <span class=string>'y'</span>.</span><br><span class=comment>--</span><br><span class=comment>-- x: first summand</span><br><span class=comment>--</span><br><span class=comment>-- y: second summand</span><br><span class=keyword>function</span>&nbsp;add<span class=operator>(</span>x,&nbsp;y<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;x&nbsp;+&nbsp;y<br><span class=keyword>end</span><br><span class=operator>]</span><span class=operator>]</span><br><span class=comment>--</span><br><span class=comment>-- Besides commenting functions, you can also give a file an introduction</span><br><span class=comment>-- by starting a doccomment without a function in the next line.</span><br><span class=comment>--[[</span><br><span class=comment>--- Arithmetic Operations</span><br><span class=comment>-- This module contains a lot of useful arithemtic operations like</span><br><span class=comment>-- + - * / % as well as pow, log, sin, cos, tan, acos, asin, atan, atan2.</span><br><span class=comment>--</span><br><span class=comment>-- This module depends on the math module.</span><br>require&nbsp;<span class=string>"math"</span><br><br><span class=comment>-- ...</span><br><span class=comment>-- rest of the file</span><br><span class=operator>]</span><span class=operator>]</span><br><span class=keyword>function</span>&nbsp;doc.parse_file&nbsp;<span class=operator>(</span>file,&nbsp;links<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;env<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;sections&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>{</span><span class=operator>}</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;doccomment,&nbsp;doctest<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;i&nbsp;<span class=operator>=</span>&nbsp;0<br><br>&nbsp;<span class=comment>-- generate new global table for the scripts</span><br>&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;setmetatable<span class=operator>(</span>env,&nbsp;<span class=operator>{</span>__index&nbsp;<span class=operator>=</span>&nbsp;_G<span class=operator>}</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;env._G&nbsp;<span class=operator>=</span>&nbsp;env<br>&nbsp;&nbsp;&nbsp;&nbsp;env.arg&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;dir&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>(</span><span class=string>"./"</span>&nbsp;..&nbsp;file<span class=operator>)</span>:match<span class=string>'(.*/)(.*)'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;env.package.path&nbsp;<span class=operator>=</span>&nbsp;dir&nbsp;..&nbsp;<span class=string>"/?.lua;"</span>&nbsp;..&nbsp;package.path<br><br>&nbsp;<span class=comment>-- helper functions</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;end_doctest&nbsp;<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:sub<span class=operator>(</span>1,&nbsp;&nbsp;8&nbsp;+&nbsp;doctest.level<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"]"</span>&nbsp;..&nbsp;<span class=operator>(</span><span class=string>"="</span><span class=operator>)</span>:rep<span class=operator>(</span>doctest.level<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"]--@RUN"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;line:sub<span class=operator>(</span>1,&nbsp;11&nbsp;+&nbsp;doctest.level<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"]"</span>&nbsp;..&nbsp;<span class=operator>(</span><span class=string>"="</span><span class=operator>)</span>:rep<span class=operator>(</span>doctest.level<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"]--@EXPECT"</span>&nbsp;<span class=keyword>then</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;ok<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;chunk,&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;loadstring<span class=operator>(</span>table.concat<span class=operator>(</span>doctest,&nbsp;<span class=string>"\n"</span><span class=operator>)</span>,&nbsp;file,&nbsp;<span class=string>"bt"</span>,&nbsp;env<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;chunk&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok,&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;xpcall<span class=operator>(</span>chunk,&nbsp;traceback&nbsp;or&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>s<span class=operator>)</span>&nbsp;<span class=keyword>return</span>&nbsp;s&nbsp;end<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- build html output of doctest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;string&nbsp;<span class=operator>=</span>&nbsp;<span class=string>"&lt;pre class=run>"</span>&nbsp;..&nbsp;highlight.highlight<span class=operator>(</span>table.concat<span class=operator>(</span>doctest,&nbsp;<span class=string>"\n"</span><span class=operator>)</span><span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/pre>"</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;expected<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:sub<span class=operator>(</span>1,&nbsp;11&nbsp;+&nbsp;doctest.level<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"]"</span>&nbsp;..&nbsp;<span class=operator>(</span><span class=string>"="</span><span class=operator>)</span>:rep<span class=operator>(</span>doctest.level<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"]--@EXPECT"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expected&nbsp;<span class=operator>=</span>&nbsp;line:sub<span class=operator>(</span>13&nbsp;+&nbsp;doctest.level<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class=operator>=</span>&nbsp;string&nbsp;..&nbsp;<span class=string>"&lt;pre class=success>"</span>&nbsp;..&nbsp;highlight.highlight<span class=operator>(</span>expected<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/pre>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;not&nbsp;ok&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;error_line&nbsp;<span class=operator>=</span>&nbsp;tonumber<span class=operator>(</span>result:match<span class=operator>(</span><span class=string>"%[string .*]:(%x+).-"</span><span class=operator>)</span>&nbsp;or&nbsp;0<span class=operator>)</span>&nbsp;+&nbsp;doctest.firstline&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"  ERROR in line "</span>&nbsp;..&nbsp;error_line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>""</span>,&nbsp;result<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;result:gsub<span class=operator>(</span><span class=string>".-\n"</span>,&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:match<span class=operator>(</span><span class=string>"^ *="</span><span class=operator>)</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;highlight.highlight<span class=operator>(</span>line<span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"\t"</span>,&nbsp;<span class=string>"    "</span><span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"  "</span>,&nbsp;<span class=string>"&nbsp; "</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;<span class=operator>=</span>&nbsp;line:gsub<span class=operator>(</span><span class=string>"&lt;"</span>,&nbsp;<span class=string>"&lt;"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:match<span class=operator>(</span><span class=string>"^TRACEBACK"</span><span class=operator>)</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;<span class=operator>=</span>&nbsp;<span class=string>"&lt;span style=color:red>"</span>&nbsp;..&nbsp;line:sub<span class=operator>(</span>1,&nbsp;-1<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/span>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;line:gsub<span class=operator>(</span><span class=string>"\n"</span>,&nbsp;<span class=string>"&lt;br>"</span><span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"\t"</span>,&nbsp;<span class=string>"    "</span><span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"  "</span>,&nbsp;<span class=string>"&nbsp; "</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class=operator>=</span>&nbsp;string&nbsp;..&nbsp;<span class=string>"&lt;pre class=error>"</span>&nbsp;..&nbsp;result&nbsp;..&nbsp;<span class=string>"&lt;/pre>"</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;repr.repr<span class=operator>(</span>result<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;expected&nbsp;~<span class=operator>=</span>&nbsp;nil&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;expected&nbsp;~<span class=operator>=</span>&nbsp;result&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"  FAIL in line "</span>&nbsp;..&nbsp;tostring<span class=operator>(</span>doctest.firstline<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"    expected: "</span>&nbsp;..&nbsp;expected<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"    instead : "</span>&nbsp;..&nbsp;result<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class=operator>=</span>&nbsp;string&nbsp;..&nbsp;<span class=string>"&lt;pre class=fail>"</span>&nbsp;..&nbsp;highlight.highlight<span class=operator>(</span>result<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/pre>"</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"  success in line "</span>&nbsp;..&nbsp;tostring<span class=operator>(</span>i<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print<span class=operator>(</span><span class=string>"  generated in line "</span>&nbsp;..&nbsp;tostring<span class=operator>(</span>i<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class=operator>=</span>&nbsp;string&nbsp;..&nbsp;<span class=string>"&lt;pre class=success>"</span>&nbsp;..&nbsp;highlight.highlight<span class=operator>(</span>result<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/pre>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- merge doctest output into doccomment</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doccomment,&nbsp;string<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doctest&nbsp;<span class=operator>=</span>&nbsp;nil&nbsp;<span class=comment>-- end doctest</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- merge doctest output into doccomment</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doccomment,&nbsp;doc.wrap<span class=operator>(</span>highlight.highlight<span class=operator>(</span>table.concat<span class=operator>(</span>doctest,&nbsp;<span class=string>"\n"</span><span class=operator>)</span><span class=operator>)</span>,&nbsp;<span class=string>"pre"</span><span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doctest&nbsp;<span class=operator>=</span>&nbsp;nil&nbsp;<span class=comment>-- end doctest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;end_doccomment&nbsp;<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;not&nbsp;sections<span class=operator>[</span><span class=operator>#</span>sections<span class=operator>]</span>.first&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- the first doccomment is the file/section-description</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- ignores line</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;<span class=operator>#</span>sections&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;1&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;f&nbsp;<span class=operator>=</span>&nbsp;io.open<span class=operator>(</span>file,&nbsp;<span class=string>"r"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;content&nbsp;<span class=operator>=</span>&nbsp;f:read<span class=operator>(</span><span class=string>"*a"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f:close<span class=operator>(</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doccomment<span class=operator>[</span><span class=operator>#</span>doccomment+1<span class=operator>]</span>&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>[</span><span class=operator>[</span><br>&lt;div&nbsp;class<span class=operator>=</span>turnable><br>&nbsp;&nbsp;&lt;input&nbsp;id<span class=operator>=</span>code-folder&nbsp;type<span class=operator>=</span>checkbox><br>&nbsp;&nbsp;&lt;label&nbsp;for<span class=operator>=</span>code-folder>View&nbsp;source-code&lt;<span class=operator>/</span>label><br>&nbsp;&nbsp;&lt;div>&lt;pre&nbsp;id<span class=operator>=</span>folded-code&nbsp;style<span class=operator>=</span>width:inherit><br><span class=operator>]</span><span class=operator>]</span>&nbsp;..&nbsp;highlight.highlight<span class=operator>(</span>content<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"&lt;/pre>&lt;/div>&lt;/div>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sections<span class=operator>[</span><span class=operator>#</span>sections<span class=operator>]</span>.first&nbsp;<span class=operator>=</span>&nbsp;doccomment<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- else a function-description</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;name,&nbsp;args&nbsp;<span class=operator>=</span>&nbsp;line:match<span class=operator>(</span><span class=string>"function (.-) -[(](.-)[)]"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;name~<span class=operator>=</span>&nbsp;nil&nbsp;and&nbsp;name~<span class=operator>=</span><span class=string>""</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doccomment,&nbsp;1,&nbsp;doccomment.first<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doccomment.first&nbsp;<span class=operator>=</span>&nbsp;tostring<span class=operator>(</span>name<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>" ("</span>&nbsp;..&nbsp;tostring<span class=operator>(</span>args<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>")"</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;name,&nbsp;args&nbsp;<span class=operator>=</span>&nbsp;line:match<span class=operator>(</span><span class=string>"(.-)= -function -[(](.-)[)]"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;name&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doccomment,&nbsp;1,&nbsp;doccomment.first<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doccomment.first&nbsp;<span class=operator>=</span>&nbsp;tostring<span class=operator>(</span>name<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>" ("</span>&nbsp;..&nbsp;tostring<span class=operator>(</span>args<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>")"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br><span class=comment>--        if line:sub(1, 6) == <span class=string>"local "</span> then</span><br><span class=comment>--            if not sections.locals then sections.locals = {} end</span><br><span class=comment>--            table.insert(sections.locals, doccomment)</span><br><span class=comment>--        else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>sections<span class=operator>[</span><span class=operator>#</span>sections<span class=operator>]</span>,&nbsp;doccomment<span class=operator>)</span><br><span class=comment>--        end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doccomment&nbsp;<span class=operator>=</span>&nbsp;nil&nbsp;<span class=comment>-- end doccomment</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;start_doccomment&nbsp;<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;doccomment&nbsp;<span class=keyword>then</span>&nbsp;end_doccomment<span class=operator>(</span><span class=string>""</span><span class=operator>)</span>&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doccomment&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span>first&nbsp;<span class=operator>=</span>&nbsp;doc.link<span class=operator>(</span>line,&nbsp;links,&nbsp;file,&nbsp;i<span class=operator>)</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;start_doctest&nbsp;<span class=operator>(</span>line,&nbsp;level<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doctest&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;not&nbsp;line:sub<span class=operator>(</span>5&nbsp;+&nbsp;level<span class=operator>)</span>:gmatch<span class=operator>(</span><span class=string>" *"</span><span class=operator>)</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doctest,&nbsp;line:sub<span class=operator>(</span>5<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doctest.level&nbsp;<span class=operator>=</span>&nbsp;level<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doctest.firstline&nbsp;<span class=operator>=</span>&nbsp;i<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;change_section&nbsp;<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_doccomment<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>sections,&nbsp;<span class=operator>{</span><span class=operator>}</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>for</span>&nbsp;line&nbsp;<span class=keyword>in</span>&nbsp;io.lines<span class=operator>(</span>file<span class=operator>)</span>&nbsp;<span class=keyword>do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;<span class=operator>=</span>&nbsp;i+1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;first_nonspace&nbsp;<span class=operator>=</span>&nbsp;line:find<span class=operator>(</span><span class=string>"[^ ]"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;doctest&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:sub<span class=operator>(</span>1,&nbsp;2&nbsp;+&nbsp;doctest.level<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"]"</span>&nbsp;..&nbsp;<span class=operator>(</span><span class=string>"="</span><span class=operator>)</span>:rep<span class=operator>(</span>doctest.level<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>"]"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_doctest<span class=operator>(</span>line<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span>&nbsp;<span class=comment>-- continue doctest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doctest,&nbsp;line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>		<span class=keyword>elseif</span>&nbsp;first_nonspace&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	line&nbsp;<span class=operator>=</span>&nbsp;line:sub<span class=operator>(</span>first_nonspace<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:sub<span class=operator>(</span>1,4<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"----"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;change_section<span class=operator>(</span>line:sub<span class=operator>(</span>5<span class=operator>)</span><span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>elseif</span>&nbsp;line:sub<span class=operator>(</span>1,3<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"---"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_doccomment<span class=operator>(</span>line:sub<span class=operator>(</span>4<span class=operator>)</span><span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>elseif</span>&nbsp;doccomment&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- continue doccomment</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;doctest_level&nbsp;<span class=operator>=</span>&nbsp;line:match<span class=operator>(</span><span class=string>"--%[(=*)%["</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;line:sub<span class=operator>(</span>1,2<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"--"</span>&nbsp;and&nbsp;doctest_level&nbsp;~<span class=operator>=</span>&nbsp;nil&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_doctest<span class=operator>(</span>line,&nbsp;<span class=operator>#</span>doctest_level<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>elseif</span>&nbsp;line:sub<span class=operator>(</span>1,2<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"--"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=comment>-- continue normal doccomment</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>doccomment,&nbsp;doc.link<span class=operator>(</span>line:sub<span class=operator>(</span>3<span class=operator>)</span>,&nbsp;links,&nbsp;file,&nbsp;i<span class=operator>)</span><span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_doccomment<span class=operator>(</span>line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;sections<br><span class=keyword>end</span><br><br><span class=comment>--- Generate documentation and run unit tests for list of sections.</span><br><span class=keyword>function</span>&nbsp;doc.gen_file&nbsp;<span class=operator>(</span>sections<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;content_template<span class=operator>(</span>section<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;doc.wrap<span class=operator>(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.concat<span class=operator>(</span>doc.map<span class=operator>(</span>section,&nbsp;function<span class=operator>(</span>def<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;doc.def_template<span class=operator>(</span>def.first,&nbsp;<span class=string>"&lt;p>"</span>..table.concat<span class=operator>(</span>def,&nbsp;<span class=string>"\n"</span><span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"\n\n"</span>,&nbsp;<span class=string>"&lt;/p>&lt;p>"</span><span class=operator>)</span>..<span class=string>"&lt;/p>"</span>&nbsp;<span class=operator>)</span>&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;<span class=string>"dl"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;<span class=keyword>function</span>&nbsp;nav_template<span class=operator>(</span>section<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;doc.wraps<span class=operator>(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doc.map<span class=operator>(</span>section,&nbsp;function<span class=operator>(</span>x<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;<span class=string>"&lt;a href=#"</span>&nbsp;..&nbsp;x.first:sub<span class=operator>(</span>1,&nbsp;<span class=operator>(</span>x.first:find<span class=operator>(</span><span class=string>" "</span><span class=operator>)</span>&nbsp;or&nbsp;1<span class=operator>)</span>-1<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>">"</span>&nbsp;..&nbsp;x.first&nbsp;..&nbsp;<span class=string>"&lt;/a>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;<span class=string>"li"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br><br><span class=comment>--    if not sections[1].first then sections[1].first = {first=<span class=string>"Reference"</span>} end</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;content,&nbsp;navigation&nbsp;<span class=operator>=</span>&nbsp;<span class=string>""</span>,&nbsp;<span class=string>"&lt;a href=index.html>> Index&lt;/a>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>for</span>&nbsp;i,&nbsp;section&nbsp;<span class=keyword>in</span>&nbsp;ipairs<span class=operator>(</span>sections<span class=operator>)</span>&nbsp;<span class=keyword>do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;description&nbsp;<span class=operator>=</span>&nbsp;sections<span class=operator>[</span>i<span class=operator>]</span>.first&nbsp;or&nbsp;<span class=operator>{</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;title&nbsp;<span class=operator>=</span>&nbsp;description.first&nbsp;or&nbsp;<span class=string>"TITLE"</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;<span class=operator>=</span>&nbsp;content<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;doc.wrap<span class=operator>(</span>title,&nbsp;i<span class=operator>=</span><span class=operator>=</span>1&nbsp;and&nbsp;<span class=string>"h1"</span>&nbsp;or&nbsp;<span class=string>"h2"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;<span class=string>"&lt;p>"</span>..table.concat<span class=operator>(</span>description,&nbsp;<span class=string>"\n"</span><span class=operator>)</span>:gsub<span class=operator>(</span><span class=string>"\n\n"</span>,&nbsp;<span class=string>"&lt;/p>&lt;p>"</span><span class=operator>)</span>..<span class=string>"&lt;p>"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;content_template<span class=operator>(</span>section<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;navigation&nbsp;<span class=operator>=</span>&nbsp;navigation<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;doc.wrap<span class=operator>(</span>title,&nbsp;i<span class=operator>=</span><span class=operator>=</span>1&nbsp;and&nbsp;<span class=string>"h2"</span>&nbsp;or&nbsp;<span class=string>"h3"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;nav_template<span class=operator>(</span>section<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;content&nbsp;~<span class=operator>=</span>&nbsp;<span class=string>"&lt;h1>Reference&lt;/h1>&lt;p>&lt;p>&lt;dl>&lt;/dl>"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;doc.file_template<span class=operator>(</span>content,&nbsp;navigation<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;false<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br><span class=keyword>end</span><br><br><span class=comment>-- Apply #doc.gen_file for Lua-files and #doc.gen_dir for directories to all</span><br><span class=comment>-- elements of dir.</span><br><span class=comment>--function doc.gen_dir (dir)</span><br><span class=comment>--    dir = dir:gsub(<span class=string>" "</span>, <span class=string>"$3; "</span>)</span><br><span class=comment>--</span><br><span class=comment>--    local t={}</span><br><span class=comment>--</span><br><span class=comment>--    local ls = io.popen(<span class=string>"ls -F "</span> .. dir):read(<span class=string>"*a"</span>)</span><br><span class=comment>--    ls:gsub(<span class=string>"(.-)\n"</span>, function (item)</span><br><span class=comment>--        if item:sub(-4) == <span class=string>".lua"</span> then</span><br><span class=comment>--            doc.gen_file(dir .. item)</span><br><span class=comment>--            t[#t+1] = dir:gsub(<span class=string>"/"</span>, <span class=string>"."</span>) .. item:sub(1, -5)</span><br><span class=comment>--</span><br><span class=comment>--        elseif item:sub(-1) == <span class=string>"/"</span> then</span><br><span class=comment>--            for i, k in ipairs(doc.gen_dir(dir .. item)) do</span><br><span class=comment>--                t[#t+1] = k</span><br><span class=comment>--            end</span><br><span class=comment>--</span><br><span class=comment>--        end</span><br><span class=comment>--    end)</span><br><span class=comment>--    return t</span><br><span class=comment>--end</span><br><br><span class=comment>---- HTML-generators</span><br><br><span class=keyword>local</span>&nbsp;max_id&nbsp;<span class=operator>=</span>&nbsp;0<br><span class=keyword>function</span>&nbsp;generate_id<span class=operator>(</span><span class=operator>)</span><br>	max_id&nbsp;<span class=operator>=</span>&nbsp;max_id&nbsp;+&nbsp;1<br>	<span class=keyword>return</span>&nbsp;max_id<br><span class=keyword>end</span><br><br><span class=comment>--- Make a HTML-dl-Element (definition list) out of a string <span class=string>'dt'</span> and a</span><br><span class=comment>-- string <span class=string>'dd'</span>. <span class=string>'dt'</span> must contain a space.</span><br><span class=comment>--[[</span><br><span class=keyword>return</span>&nbsp;doc.def_template<span class=operator>(</span><span class=string>"Fish (Animal)"</span>,&nbsp;<span class=string>"Fish (from latin fishius) is a animal commonly found in water."</span><span class=operator>)</span><br><span class=operator>]</span><span class=operator>]</span><span class=comment>--@RUN</span><br><span class=keyword>function</span>&nbsp;doc.def_template<span class=operator>(</span>dt,&nbsp;dd<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;id&nbsp;<span class=operator>=</span>&nbsp;dt:sub<span class=operator>(</span>1,&nbsp;<span class=operator>(</span>dt:find<span class=operator>(</span><span class=string>" "</span><span class=operator>)</span>&nbsp;or&nbsp;1<span class=operator>)</span>-1<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;<span class=string>"&lt;dt id="</span>&nbsp;..&nbsp;id&nbsp;..&nbsp;<span class=string>">"</span>&nbsp;..&nbsp;<span class=string>"&lt;a href=#"</span>&nbsp;..&nbsp;id&nbsp;..&nbsp;<span class=string>">"</span>&nbsp;..&nbsp;dt&nbsp;..&nbsp;<span class=string>"&lt;/a>"</span>&nbsp;..&nbsp;<span class=string>"&lt;/dt>\n&lt;dd>"</span>&nbsp;..&nbsp;dd&nbsp;..&nbsp;<span class=string>"&lt;/dd>"</span><br><span class=keyword>end</span><br><br><span class=comment>--- An html template.</span><br><span class=comment>-- pass a string <span class=string>'content'</span> and a string <span class=string>'navigation'</span>. returns an html string.</span><br><span class=keyword>function</span>&nbsp;doc.file_template<span class=operator>(</span>content,&nbsp;navigation<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;<span class=operator>[</span><span class=operator>[</span><br>&lt;!doctype&nbsp;html>&lt;html>&lt;head><br>&nbsp;&nbsp;&lt;meta&nbsp;charset<span class=operator>=</span>utf-8><br>&nbsp;&nbsp;&lt;title>Reference&lt;<span class=operator>/</span>title><br>&nbsp;&nbsp;&lt;link&nbsp;href<span class=operator>=</span><span class=string>"style.css"</span>&nbsp;rel<span class=operator>=</span><span class=string>"stylesheet"</span>&nbsp;type<span class=operator>=</span><span class=string>"text/css"</span>>&lt;<span class=operator>/</span>meta><br><br>&lt;<span class=operator>/</span>head>&lt;body><br>&nbsp;&nbsp;&lt;div&nbsp;id<span class=operator>=</span>content><br><span class=operator>]</span><span class=operator>]</span>&nbsp;..&nbsp;content&nbsp;..&nbsp;<span class=operator>[</span><span class=operator>[</span><br><br>&nbsp;&nbsp;&lt;<span class=operator>/</span>div>&lt;div&nbsp;id<span class=operator>=</span>navigation><br><span class=operator>]</span><span class=operator>]</span>..&nbsp;navigation&nbsp;..&nbsp;<span class=operator>[</span><span class=operator>[</span><br><br>&nbsp;&nbsp;&lt;<span class=operator>/</span>div>&lt;footer&nbsp;style<span class=operator>=</span>margin-right><br>&nbsp;&nbsp;&nbsp;&nbsp;generated&nbsp;with&nbsp;docl<br>&nbsp;&nbsp;&lt;<span class=operator>/</span>footer>&lt;<span class=operator>/</span>body>&lt;<span class=operator>/</span>html><span class=operator>]</span><span class=operator>]</span><br><span class=keyword>end</span><br><br><span class=comment>--- Link #path.to.something for local references and $path.to.something for references to other files.</span><br><span class=keyword>function</span>&nbsp;doc.link&nbsp;<span class=operator>(</span>string,&nbsp;links,&nbsp;file,&nbsp;line<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;alphanum&nbsp;<span class=operator>=</span>&nbsp;<span class=string>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPRSTUVVWXYZ0123456789"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;string<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:gsub<span class=operator>(</span><span class=string>"<span class=string>'(.-)'</span>"</span>,&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>code<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;doc.wrap<span class=operator>(</span>highlight.highlight<span class=operator>(</span>code<span class=operator>)</span>,&nbsp;<span class=string>"code"</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<span class=operator>)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:gsub<span class=operator>(</span><span class=string>"$(["</span>&nbsp;..&nbsp;alphanum&nbsp;..&nbsp;<span class=string>"_./#]+)"</span>,&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>path<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;end_&nbsp;<span class=operator>=</span>&nbsp;<span class=string>""</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>if</span>&nbsp;path:sub<span class=operator>(</span>-1<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"."</span>&nbsp;or&nbsp;path:sub<span class=operator>(</span>-1<span class=operator>)</span>&nbsp;<span class=operator>=</span><span class=operator>=</span>&nbsp;<span class=string>"/"</span>&nbsp;<span class=keyword>then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;<span class=operator>=</span>&nbsp;path:sub<span class=operator>(</span>1,&nbsp;-2<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end_&nbsp;<span class=operator>=</span>&nbsp;<span class=string>"."</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;point&nbsp;<span class=operator>=</span>&nbsp;path:find<span class=operator>(</span><span class=string>"#"</span><span class=operator>)</span>&nbsp;or&nbsp;<span class=operator>#</span>path+1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;link&nbsp;<span class=operator>=</span>&nbsp;path:sub<span class=operator>(</span>1,&nbsp;point-1<span class=operator>)</span>&nbsp;..&nbsp;<span class=string>".lua.html#"</span>&nbsp;..&nbsp;path:sub<span class=operator>(</span>point+1<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>links,&nbsp;<span class=operator>{</span>url<span class=operator>=</span>link,&nbsp;file<span class=operator>=</span>file,&nbsp;line<span class=operator>=</span>line<span class=operator>}</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;<span class=string>"&lt;a href="</span>&nbsp;..&nbsp;link&nbsp;..&nbsp;<span class=string>">"</span>&nbsp;..&nbsp;path&nbsp;..&nbsp;<span class=string>"&lt;/a>"</span>&nbsp;..&nbsp;end_<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<span class=operator>)</span><br><br><span class=comment>--        :gsub(<span class=string>"#(["</span>..alphanum..<span class=string>"_./]*)"</span>, function (path)</span><br><span class=comment>--            local end_ = <span class=string>""</span></span><br><span class=comment>--            if path:sub(-1) == <span class=string>"."</span> or path:sub(-1) == <span class=string>"/"</span> then</span><br><span class=comment>--                path = path:sub(1, -2)</span><br><span class=comment>--                end_ = <span class=string>"."</span></span><br><span class=comment>--            end</span><br><span class=comment>--            local point = #path -- - path:reverse():find(<span class=string>"%."</span>)</span><br><span class=comment>--            return <span class=string>"&lt;a href=#"</span> .. path .. <span class=string>">"</span> .. path .. <span class=string>"&lt;/a>"</span> .. end_</span><br><span class=comment>--        end)</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;result<br><span class=keyword>end</span><br><br><span class=comment>--- Wrap text with HMTL-Element elem.</span><br><span class=comment>--[[</span><br><span class=keyword>return</span>&nbsp;doc.wrap<span class=operator>(</span><span class=string>"in italics"</span>,&nbsp;<span class=string>"em"</span><span class=operator>)</span><br><span class=operator>]</span><span class=operator>]</span><span class=comment>--@EXPECT <span class=string>"&lt;em>in italics&lt;/em>"</span></span><br><span class=keyword>function</span>&nbsp;doc.wrap<span class=operator>(</span>text,&nbsp;element,&nbsp;attrs<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;table.concat&nbsp;<span class=operator>{</span><span class=string>"&lt;"</span>,&nbsp;element,&nbsp;<span class=string>">"</span>,&nbsp;text,&nbsp;<span class=string>"&lt;/"</span>,&nbsp;element,&nbsp;<span class=string>">"</span><span class=operator>}</span><br><span class=keyword>end</span><br><br><span class=comment>--- Wrap a list of elements with HTML-Element elem.</span><br><span class=comment>--[[</span><br><span class=keyword>return</span>&nbsp;doc.wraps<span class=operator>(</span><span class=operator>{</span><span class=string>"hallo"</span>,&nbsp;<span class=string>"bello"</span>,&nbsp;<span class=string>"cello"</span><span class=operator>}</span>,&nbsp;<span class=string>"p"</span><span class=operator>)</span><br><span class=operator>]</span><span class=operator>]</span><span class=comment>--@EXPECT <span class=string>"&lt;p>hallo&lt;/p>&lt;p>bello&lt;/p>&lt;p>cello&lt;/p>"</span></span><br><span class=keyword>function</span>&nbsp;doc.wraps<span class=operator>(</span>list,&nbsp;element<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;table.concat<span class=operator>(</span>doc.map<span class=operator>(</span>list,&nbsp;doc.wrap,&nbsp;element<span class=operator>)</span><span class=operator>)</span><br><span class=keyword>end</span><br><br><span class=comment>---- Useful helper functions</span><br><span class=comment>--- Transform elems of list with f.</span><br><span class=comment>--[[</span><br><span class=keyword>return</span>&nbsp;doc.map<span class=operator>(</span><span class=operator>{</span>1,2,3<span class=operator>}</span>,&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>x<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;x+1<br>end<span class=operator>)</span><br><span class=operator>]</span><span class=operator>]</span><span class=comment>--@EXPECT {2, 3, 4}</span><br><span class=keyword>function</span>&nbsp;doc.map<span class=operator>(</span>list,&nbsp;f,&nbsp;...<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>local</span>&nbsp;result&nbsp;<span class=operator>=</span>&nbsp;<span class=operator>{</span><span class=operator>}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>for</span>&nbsp;i,&nbsp;item&nbsp;<span class=keyword>in</span>&nbsp;ipairs<span class=operator>(</span>list<span class=operator>)</span>&nbsp;<span class=keyword>do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table.insert<span class=operator>(</span>result,&nbsp;f<span class=operator>(</span>item,&nbsp;...<span class=operator>)</span><span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;result<br><span class=keyword>end</span><br><br><span class=comment>-- Replace every element of list with its key-property.</span><br><span class=comment>--[[</span><br><span class=comment>--]]--@RUN</span><br><span class=comment>--function partial(func, ...)</span><br><span class=comment>--    local args = {...}; local len = #args</span><br><span class=comment>--    return function(...)</span><br><span class=comment>--        local params = {unpack(args)}                      -- copy</span><br><span class=comment>--        for i,e in ipairs {...} do params[len + i] = e end -- merge</span><br><span class=comment>--        return func(unpack(params))                        -- apply</span><br><span class=comment>--    end</span><br><span class=comment>--end</span><br><br><span class=keyword>return</span>&nbsp;doc<br></pre></div></div><p><dl><dt id=doc.parse_file><a href=#doc.parse_file>doc.parse_file (file, links)</a></dt>
<dd><p> Parse documention from file.
 returns a list of sections, where each section is a list of defintions plus a description.</p><p> A Doccomment begins with <code><span class=comment>---</span></code> and continues with <code><span class=comment>--</span></code>, newlines are ignored,
 empty lines seperate paragraphs. For example:
<pre><span class=comment>--- Add 2 numbers.</span><br><span class=comment>-- This function the two numbers <span class=string>'x'</span> and <span class=string>'y'</span>.</span><br><span class=comment>--</span><br><span class=comment>-- x: first summand</span><br><span class=comment>--</span><br><span class=comment>-- y: second summand</span><br><span class=keyword>function</span>&nbsp;add<span class=operator>(</span>x,&nbsp;y<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;x&nbsp;+&nbsp;y<br><span class=keyword>end</span></pre></p><p> Besides commenting functions, you can also give a file an introduction
 by starting a doccomment without a function in the next line.
<pre><span class=comment>--- Arithmetic Operations</span><br><span class=comment>-- This module contains a lot of useful arithemtic operations like</span><br><span class=comment>-- + - * / % as well as pow, log, sin, cos, tan, acos, asin, atan, atan2.</span><br><span class=comment>--</span><br><span class=comment>-- This module depends on the math module.</span><br>require&nbsp;<span class=string>"math"</span><br><br><span class=comment>-- ...</span><br><span class=comment>-- rest of the file</span></pre></p></dd><dt id=doc.gen_file><a href=#doc.gen_file>doc.gen_file (sections)</a></dt>
<dd><p> Generate documentation and run unit tests for list of sections.</p></dd></dl><h2> HTML-generators</h2><p><p><dl><dt id=doc.def_template><a href=#doc.def_template>doc.def_template (dt, dd)</a></dt>
<dd><p> Make a HTML-dl-Element (definition list) out of a string <code>dt</code> and a
 string <code>dd</code>. <code>dt</code> must contain a space.
<pre class=run><span class=keyword>return</span>&nbsp;doc.def_template<span class=operator>(</span><span class=string>"Fish (Animal)"</span>,&nbsp;<span class=string>"Fish (from latin fishius) is a animal commonly found in water."</span><span class=operator>)</span></pre><pre class=success><span class=string>"&lt;dt id=Fish>&lt;a href=#Fish>Fish (Animal)&lt;/a>&lt;/dt>\<br>&lt;dd>Fish (from latin fishius) is a animal commonly found in water.&lt;/dd>"</span></pre></p></dd><dt id=doc.file_template><a href=#doc.file_template>doc.file_template (content, navigation)</a></dt>
<dd><p> An html template.
 pass a string <code>content</code> and a string <code>navigation</code>. returns an html string.</p></dd><dt id=doc.link><a href=#doc.link>doc.link (string, links, file, line)</a></dt>
<dd><p> Link #path.to.something for local references and <a href=path.to.something.lua.html#>path.to.something</a> for references to other files.</p></dd><dt id=doc.wrap><a href=#doc.wrap>doc.wrap (text, element, attrs)</a></dt>
<dd><p> Wrap text with HMTL-Element elem.
<pre class=run><span class=keyword>return</span>&nbsp;doc.wrap<span class=operator>(</span><span class=string>"in italics"</span>,&nbsp;<span class=string>"em"</span><span class=operator>)</span></pre><pre class=success><span class=string>"&lt;em>in italics&lt;/em>"</span></pre></p></dd><dt id=doc.wraps><a href=#doc.wraps>doc.wraps (list, element)</a></dt>
<dd><p> Wrap a list of elements with HTML-Element elem.
<pre class=run><span class=keyword>return</span>&nbsp;doc.wraps<span class=operator>(</span><span class=operator>{</span><span class=string>"hallo"</span>,&nbsp;<span class=string>"bello"</span>,&nbsp;<span class=string>"cello"</span><span class=operator>}</span>,&nbsp;<span class=string>"p"</span><span class=operator>)</span></pre><pre class=success><span class=string>"&lt;p>hallo&lt;/p>&lt;p>bello&lt;/p>&lt;p>cello&lt;/p>"</span></pre></p></dd></dl><h2> Useful helper functions</h2><p><p><dl><dt id=doc.map><a href=#doc.map>doc.map (list, f, ...)</a></dt>
<dd><p> Transform elems of list with f.
<pre class=run><span class=keyword>return</span>&nbsp;doc.map<span class=operator>(</span><span class=operator>{</span>1,2,3<span class=operator>}</span>,&nbsp;<span class=keyword>function</span>&nbsp;<span class=operator>(</span>x<span class=operator>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=keyword>return</span>&nbsp;x+1<br>end<span class=operator>)</span></pre><pre class=success><span class=operator>{</span>2,&nbsp;3,&nbsp;4<span class=operator>}</span></pre></p></dd></dl>
  </div><div id=navigation>
<a href=index.html>> Index</a><h2> helper functions</h2><li><a href=#doc.parse_file>doc.parse_file (file, links)</a></li><li><a href=#doc.gen_file>doc.gen_file (sections)</a></li><h3> HTML-generators</h3><li><a href=#doc.def_template>doc.def_template (dt, dd)</a></li><li><a href=#doc.file_template>doc.file_template (content, navigation)</a></li><li><a href=#doc.link>doc.link (string, links, file, line)</a></li><li><a href=#doc.wrap>doc.wrap (text, element, attrs)</a></li><li><a href=#doc.wraps>doc.wraps (list, element)</a></li><h3> Useful helper functions</h3><li><a href=#doc.map>doc.map (list, f, ...)</a></li>
  </div><footer style=margin-right>
    generated with docl
  </footer></body></html>